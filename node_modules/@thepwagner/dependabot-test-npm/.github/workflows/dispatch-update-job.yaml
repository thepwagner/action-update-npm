name: Dependabot Update Job
on:
  repository_dispatch:
    types: update-job-v1
jobs:
  update-job:
    name: Automated Update
    runs-on: self-hosted
    container:
      image: pwagner/dar:env
    steps:
    - name: azurecr.io login
      id: azlogin
      env:
        APP_ID: c50ff8fe-1b72-47a5-b18a-492702b5dfd5
        TENANT_ID: 456c9a7f-94f5-4a79-86f5-a832c55820ba
        ACR_PULLER_PASSWORD: ${{ secrets.ACR_PULLER_PASSWORD }}
        REGISTRY_NAME: thepwagner
      run: |
        az login --service-principal -u "$APP_ID" -p "$ACR_PULLER_PASSWORD" --tenant "$TENANT_ID"
        az acr login --name "$REGISTRY_NAME"
        echo "::set-output name=DOCKER_IDENTITY_TOKEN::$(jq -r '.auths["thepwagner.azurecr.io"].identitytoken' ~/.docker/config.json)"
    - name: Run the Job
      uses: docker://pwagner/dar:latest
      env:
        DOCKER_IDENTITY_TOKEN: ${{ steps.azlogin.outputs.DOCKER_IDENTITY_TOKEN }} 
